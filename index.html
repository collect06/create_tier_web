<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ルーム選択</title>
<link rel="stylesheet" href="style.css">
  
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="indexPage">
  
<div id="intro">
  <video
   id="introVideo" 
   autoplay
   muted
   playsinline
  >
    <source src="video/intro.mp4" type="video/mp4">
  </video>
  <button id="skipBtn">SKIP</button>
</div>

<div id="mainContent" style="display:none">
  <h2>ながおありがとう</h2>

  <p>名前：<input id="name"></p>
  <p>合言葉：<input id="room"></p>

  <button onclick="enter('play')">参加</button>
  <button onclick="enter('watch')">観戦</button>
</div>
  
<script>
/* ===== Firebase ===== */
 firebaseConfig = {
  apiKey: "AIzaSyCzU2Gv2cVxtkYdG4G4iWBf-vilMLUblIM",
  authDomain: "create-tier.firebaseapp.com",
  databaseURL: "https://create-tier-default-rtdb.firebaseio.com",
  projectId: "create-tier",
  storageBucket: "create-tier.firebasestorage.app",
  messagingSenderId: "267436992720",
  appId: "1:267436992720:web:fe5c825719bce282a8d6d5"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();


function enter(mode) {
  const name = document.getElementById("name").value.trim();
  const room = document.getElementById("room").value.trim();

  if (!name || !room) {
    alert("名前と合言葉を入力してください");
    return;
  }

  if (mode === "watch") {
    location.href =
      `battle.html?mode=watch&name=${encodeURIComponent(name)}&room=${encodeURIComponent(room)}`;
    return;
  }

  const playersRef = db.ref(`rooms/${room}/players`);

  playersRef.once("value")
    .then(snap => {
      const players = snap.val() || {};
      if (Object.keys(players).length >= 2) {
        alert("このルームは満員です。\n観戦モードをご利用ください。");
        return;
      }

      location.href =
        `battle.html?mode=play&name=${encodeURIComponent(name)}&room=${encodeURIComponent(room)}`;
    })
    .catch(err => {
      console.error(err);
      alert("接続エラーが発生しました");
    });
}


/* ===== intro 制御 ===== */
document.addEventListener("DOMContentLoaded", () => {
  const intro = document.getElementById("intro");
  const video = document.getElementById("introVideo");
  const main = document.getElementById("mainContent");
  const skipBtn = document.getElementById("skipBtn");

  if (!intro || !video || !main) return;

  const seen = sessionStorage.getItem("introSeen") === "true";

  /* すでに見た場合 */
  if (seen) {
    intro.style.display = "none";
    main.style.display = "block";
    return;
  }

  /* 初回 */
  intro.style.display = "flex";
  main.style.display = "none";

  video.currentTime = 0;
  video.play().catch(() => {});

  function finishIntro() {
    sessionStorage.setItem("introSeen", "true");
    intro.classList.add("fadeout");
    setTimeout(() => {
      intro.style.display = "none";
      main.style.display = "block";
    }, 1000);
  }

  video.addEventListener("ended", finishIntro);
  skipBtn.addEventListener("click", finishIntro);
});
</script>

</div>
</body>
</html>








