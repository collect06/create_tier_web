<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Battle</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2>バトルルーム</h2>

<p id="counts"></p>
<p id="status"></p>

<div id="inputArea" style="display:none">
  <input id="textInput" placeholder="文字を入力">
  <button id="runBtn">実行</button>
</div>

<pre id="result" style="display:none"></pre>

<button id="rematchBtn" style="display:none">再戦</button>
<button id="leaveBtn">退出</button>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCzU2Gv2cVxtkYdG4G4iWBf-vilMLUblIM",
  authDomain: "create-tier.firebaseapp.com",
  projectId: "create-tier",
  storageBucket: "create-tier.firebasestorage.app",
  messagingSenderId: "267436992720",
  appId: "1:267436992720:web:fe5c825719bce282a8d6d5"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

/* ===== URL ===== */
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const name = params.get("name");
const mode = params.get("mode"); // play / watch

/* ===== DOM ===== */
const statusEl = document.getElementById("status");
const countsEl = document.getElementById("counts");
const inputArea = document.getElementById("inputArea");
const textInput = document.getElementById("textInput");
const runBtn = document.getElementById("runBtn");
const resultEl = document.getElementById("result");
const rematchBtn = document.getElementById("rematchBtn");
const leaveBtn = document.getElementById("leaveBtn");

/* ===== 状態 ===== */
let uid;
let hasAppeared = false;
let roomRef, playersRef, spectatorsRef;

/* ===== 認証 ===== */
auth.signInAnonymously().then(res => {
  uid = res.user.uid;

  roomRef = db.ref(`rooms/${roomId}`);
  playersRef = roomRef.child("players");
  spectatorsRef = roomRef.child("spectators");

  if (mode === "play") {
    playersRef.child(uid).set({
      name,
      submitted: false,
      result: ""
    });
  } else {
    spectatorsRef.child(uid).set(true);
  }

  setupListeners();
});

/* ===== 実行 ===== */
runBtn.onclick = () => {
  const text = textInput.value.trim();
  if (!text) return;

  playersRef.child(uid).update({
    submitted: true,
    result: shuffle(text)
  });
};

/* ===== 再戦 ===== */
rematchBtn.onclick = () => {
  playersRef.once("value", snap => {
    snap.forEach(p => {
      p.ref.update({ submitted: false, result: "" });
    });
  });
};

/* ===== 退出 ===== */
leaveBtn.onclick = () => {
  cleanup();
  const ref = mode === "play" ? playersRef : spectatorsRef;
  ref.child(uid).remove().then(() => {
    location.href = "index.html";
  });
};

/* ===== 監視 ===== */
function setupListeners() {
  roomRef.on("value", snap => {
    const data = snap.val();
    if (!data) return;

    const players = data.players || {};
    const spectators = data.spectators || {};
    const playerIds = Object.keys(players);

    countsEl.textContent =
      `参加者: ${playerIds.length}人 / 観戦者: ${Object.keys(spectators).length}人`;

    if (mode === "play") {
      if (players[uid]) hasAppeared = true;
      if (hasAppeared && !players[uid]) {
        cleanup();
        location.href = "index.html";
        return;
      }
    }

    /* ===== 観戦モード ===== */
    if (mode === "watch") {
      inputArea.style.display = "none";
      rematchBtn.style.display = "none";

      if (playerIds.length < 2) {
        statusEl.textContent = "対戦者がそろうのを待っています…";
        resultEl.style.display = "none";
        return;
      }

      const p1 = players[playerIds[0]];
      const p2 = players[playerIds[1]];

      if (
        p1.submitted && p2.submitted &&
        p1.result && p2.result
      ) {
        statusEl.textContent = "結果発表！";
        resultEl.style.display = "block";

        resultEl.textContent =
          `${p1.name}: ${p1.result}（${calcScore(p1.result)}点）\n` +
          `${p2.name}: ${p2.result}（${calcScore(p2.result)}点）`;
      } else {
        statusEl.textContent = "対戦中…";
        resultEl.style.display = "none";
      }
      return;
    }

    /* ===== 対戦モード ===== */
    if (playerIds.length === 1) {
      playersRef.child(playerIds[0]).update({
        submitted: false,
        result: ""
      });
      statusEl.textContent = "対戦相手の参加を待っています…";
      inputArea.style.display = "none";
      resultEl.style.display = "none";
      rematchBtn.style.display = "none";
      return;
    }

    const me = players[uid];
    const otherId = playerIds.find(id => id !== uid);
    const other = players[otherId];

    if (!me.submitted && !other.submitted) {
      statusEl.textContent = "入力して「実行」を押してください";
      inputArea.style.display = "block";
      resultEl.style.display = "none";
      rematchBtn.style.display = "none";
      return;
    }

    if (!me.submitted && other.submitted) {
      statusEl.textContent = "相手は入力済みです。入力してください";
      inputArea.style.display = "block";
      return;
    }

    if (me.submitted && !other.submitted) {
      statusEl.textContent = "相手の入力を待っています…";
      inputArea.style.display = "none";
      return;
    }

    if (
      me.submitted && other.submitted &&
      me.result && other.result
    ) {
      statusEl.textContent = "結果発表！";
      inputArea.style.display = "none";
      rematchBtn.style.display = "inline";
      resultEl.style.display = "block";

      resultEl.textContent =
        `${me.name}: ${me.result}（${calcScore(me.result)}点）\n` +
        `${other.name}: ${other.result}（${calcScore(other.result)}点）`;
    }
  });
}

function cleanup() {
  if (roomRef) roomRef.off();
}

/* ===== util ===== */
function shuffle(str) {
  const a = str.split("");
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a.join("");
}

function calcScore(text) {
  if (!text) return 0;
  let score = 0;
  const hands = [
    { pattern: "あい", point: 1 },
    { pattern: "あいう", point: 2 }
  ];
  hands.forEach(h => {
    if (text.includes(h.pattern)) score += h.point;
  });
  return score;
}
</script>
</body>
</html>
