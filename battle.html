<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒˆãƒ«</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2 id="title"></h2>
<p id="info"></p>
<p id="statusMsg"></p>

<div id="playerUI">
  <input id="input" placeholder="æ–‡å­—åˆ—ã‚’å…¥åŠ›">
  <button id="run">å®Ÿè¡Œ</button>
</div>

<button id="rematch" style="display:none">å†æˆ¦</button>
<button id="leave">é€€å‡º</button>

<pre id="result" style="display:none"></pre>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCzU2Gv2cVxtkYdG4G4iWBf-vilMLUblIM",
  authDomain: "create-tier.firebaseapp.com",
  projectId: "create-tier",
  storageBucket: "create-tier.firebasestorage.app",
  messagingSenderId: "267436992720",
  appId: "1:267436992720:web:fe5c825719bce282a8d6d5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* URL */
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const name = params.get("name");
const mode = params.get("mode");

/* DOM */
const statusMsg = document.getElementById("statusMsg");
const playerUI = document.getElementById("playerUI");
const runBtn = document.getElementById("run");
const rematchBtn = document.getElementById("rematch");
const leaveBtn = document.getElementById("leave");
const result = document.getElementById("result");

/* çŠ¶æ…‹ãƒ•ãƒ©ã‚° */
let hasAppeared = false;
let roomListener = null;

auth.signInAnonymously().then(({ user }) => {
  const uid = user.uid;
  const roomRef = db.ref(`rooms/${roomId}`);
  const playersRef = roomRef.child("players");

  /* å‚åŠ  */
  if (mode === "play") {
    playersRef.child(uid).set({
      name,
      submitted: false,
      result: ""
    });
  }

  /* å®Ÿè¡Œ */
  runBtn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;
    playersRef.child(uid).update({
      submitted: true,
      result: shuffle(text)
    });
  };

  /* å†æˆ¦ */
  rematchBtn.onclick = () => {
    playersRef.once("value", snap => {
      snap.forEach(p => {
        p.ref.update({ submitted: false, result: "" });
      });
    });
  };

  /* é€€å‡º */
  leaveBtn.onclick = () => {
    cleanup();
    playersRef.child(uid).remove().then(() => {
      location.href = "index.html";
    });
  };

  /* ç›£è¦– */
  roomListener = roomRef.on("value", snap => {
    const data = snap.val();
    if (!data || !data.players) return;

    const players = data.players;

    // ğŸ‘‡ ä¸€åº¦ã§ã‚‚è¦‹ãˆãŸã‚‰ true
    if (players[uid]) {
      hasAppeared = true;
    }

    // ğŸ‘‡ å‡ºç¾å¾Œã«æ¶ˆãˆãŸã‚‰ã€Œé€€å‡ºã€
    if (hasAppeared && !players[uid]) {
      cleanup();
      location.href = "index.html";
      return;
    }

    const others = Object.entries(players).filter(([k]) => k !== uid);

    if (others.length === 0) {
      statusMsg.textContent = "å¯¾æˆ¦ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦";
      playerUI.style.display = "none";
      result.style.display = "none";
      rematchBtn.style.display = "none";
      return;
    }

    const me = players[uid];
    const opponent = others[0][1];

    if (!me.submitted && !opponent.submitted) {
      statusMsg.textContent = "å…¥åŠ›ã—ã¦ã€Œå®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";
      playerUI.style.display = "block";
    } else if (!me.submitted && opponent.submitted) {
      statusMsg.textContent = "ç›¸æ‰‹ã¯å…¥åŠ›æ¸ˆã¿ã§ã™ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„";
      playerUI.style.display = "block";
    } else if (me.submitted && !opponent.submitted) {
      statusMsg.textContent = "ç›¸æ‰‹ã®å…¥åŠ›ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦";
      playerUI.style.display = "none";
    } else {
      statusMsg.textContent = "çµæœç™ºè¡¨ï¼";
      playerUI.style.display = "none";
      result.style.display = "block";
      result.textContent =
        `${me.name}: ${me.result}\n${opponent.name}: ${opponent.result}`;
      rematchBtn.style.display = "inline";
      return;
    }

    result.style.display = "none";
    rematchBtn.style.display = "none";
  });

  function cleanup() {
    if (roomListener) {
      roomRef.off("value", roomListener);
      roomListener = null;
    }
  }
});

function shuffle(str) {
  const a = str.split("");
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a.join("");
}
</script>
</body>
</html>
