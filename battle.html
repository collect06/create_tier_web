<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>賭けながお</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2 id="title"></h2>
<p id="info"></p>
<p id="statusMsg"></p>

<div id="playerUI">
  <input id="input" placeholder="文字列を入力">
  <button id="run">対戦ながお</button>
  <button id="rematch" style="display:none">再戦ながお</button>
</div>

<pre id="result" style="display:none"></pre>

<script>
// =====================
// Firebase 初期化
// =====================
const firebaseConfig = {
    apiKey: "AIzaSyCzU2Gv2cVxtkYdG4G4iWBf-vilMLUblIM",
  authDomain: "create-tier.firebaseapp.com",
  projectId: "create-tier",
  storageBucket: "create-tier.firebasestorage.app",
  messagingSenderId: "267436992720",
  appId: "1:267436992720:web:fe5c825719bce282a8d6d5"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// =====================
// URL パラメータ
// =====================
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const name = params.get("name");
const mode = params.get("mode"); // play / watch

// =====================
// DOM
// =====================
const title = document.getElementById("title");
const info = document.getElementById("info");
const statusMsg = document.getElementById("statusMsg");
const input = document.getElementById("input");
const runBtn = document.getElementById("run");
const rematchBtn = document.getElementById("rematch");
const result = document.getElementById("result");
const playerUI = document.getElementById("playerUI");

title.textContent = `ルーム: ${roomId}`;
info.textContent = mode === "watch" ? "観戦モード" : `プレイヤー: ${name}`;

if (mode === "watch") {
  playerUI.style.display = "none";
}

// =====================
// ログイン & ルーム処理
// =====================
auth.signInAnonymously().then(({ user }) => {
  const uid = user.uid;

  const roomRef = db.ref(`rooms/${roomId}`);
  const playersRef = roomRef.child("players");
  const spectatorsRef = roomRef.child("spectators");
  const stateRef = roomRef.child("state");

  // -------- 観戦モード --------
  if (mode === "watch") {
    spectatorsRef.child(uid).set({ joinedAt: Date.now() });
  }

  // -------- プレイヤー参加 --------
  if (mode === "play") {
    playersRef.once("value", snap => {
      if (snap.numChildren() >= 2) {
        alert("この部屋は満員です");
        location.href = "index.html";
        return;
      }

      playersRef.child(uid).set({
        name,
        submitted: false,
        result: ""
      });
    });
  }

  // -------- プレイヤー人数監視 --------
  playersRef.on("value", snap => {
    const count = snap.numChildren();
    if (count < 2) {
      stateRef.set({ status: "waiting" });
    } else if (count === 2) {
      stateRef.set({ status: "ready" });
    }
  });

  // -------- 実行ボタン --------
  runBtn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;

    const shuffled = shuffle(text);

    playersRef.child(uid).update({
      result: shuffled,
      submitted: true
    }).then(() => {
      stateRef.child("status").transaction(current => {
        return current === "ready" ? "submitted" : current;
      });
    });
  };

  // -------- 再戦 --------
  rematchBtn.onclick = () => {
    playersRef.once("value", snap => {
      snap.forEach(p => {
        p.ref.update({
          submitted: false,
          result: ""
        });
      });
      stateRef.set({ status: "ready" });
    });
  };

  // -------- ルーム監視（UI制御） --------
  roomRef.on("value", snap => {
    const data = snap.val();
    if (!data || !data.players || !data.state) return;

    const players = Object.values(data.players);
    const status = data.state.status;

    // 状態メッセージ
    statusMsg.textContent = {
      waiting: "対戦相手の参加を待っていますかき…",
      ready: "入力して「対戦ながお」を押してくださいんぽ",
      submitted: "相手の入力を待っていますかき…",
      revealed: "結果発表！"
    }[status] || "";

    // 両者提出チェック
    if (
      status !== "revealed" &&
      players.length === 2 &&
      players.every(p => p.submitted)
    ) {
      stateRef.set({ status: "revealed" });
      return;
    }

    // 結果表示制御
    if (status === "revealed") {
      result.style.display = "block";
      result.textContent =
        players.map(p => `${p.name}: ${p.result}`).join("\n");
      rematchBtn.style.display = mode === "play" ? "inline" : "none";
    } else {
      result.style.display = "none";
      result.textContent = "";
      rematchBtn.style.display = "none";
    }
  });

  // -------- 退出処理 --------
  window.addEventListener("beforeunload", () => {
    if (mode === "watch") {
      spectatorsRef.child(uid).remove();
    } else {
      playersRef.child(uid).remove().then(() => {
        playersRef.once("value", snap => {
          if (!snap.exists()) {
            roomRef.remove();
          }
        });
      });
    }
  });
});

// =====================
// 文字列シャッフル
// =====================
function shuffle(str) {
  const arr = str.split("");
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.join("");
}
</script>
</body>
</html>
