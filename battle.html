<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Battle</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2 id="title"></h2>
<p id="status"></p>

<div id="inputArea" style="display:none">
  <input id="textInput" placeholder="文字を入力">
  <button id="runBtn">実行</button>
</div>

<pre id="result" style="display:none"></pre>

<button id="rematchBtn" style="display:none">再戦</button>
<button id="leaveBtn">退出</button>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCzU2Gv2cVxtkYdG4G4iWBf-vilMLUblIM",
  authDomain: "create-tier.firebaseapp.com",
  projectId: "create-tier",
  storageBucket: "create-tier.firebasestorage.app",
  messagingSenderId: "267436992720",
  appId: "1:267436992720:web:fe5c825719bce282a8d6d5"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

/* ===== URL ===== */
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const playerName = params.get("name");
const mode = params.get("mode");

/* ===== DOM ===== */
const statusEl = document.getElementById("status");
const inputArea = document.getElementById("inputArea");
const textInput = document.getElementById("textInput");
const runBtn = document.getElementById("runBtn");
const resultEl = document.getElementById("result");
const rematchBtn = document.getElementById("rematchBtn");
const leaveBtn = document.getElementById("leaveBtn");

/* ===== 状態 ===== */
let uid = null;
let hasAppeared = false;
let roomRef = null;
let playersRef = null;

/* ===== 認証 ===== */
auth.signInAnonymously().then(res => {
  uid = res.user.uid;

  roomRef = db.ref(`rooms/${roomId}`);
  playersRef = roomRef.child("players");

  if (mode === "play") {
    playersRef.child(uid).set({
      name: playerName,
      submitted: false,
      result: ""
    });
  }

  setupListeners();
});

/* ===== 実行 ===== */
runBtn.onclick = () => {
  const text = textInput.value.trim();
  if (!text) return;

  playersRef.child(uid).update({
    submitted: true,
    result: shuffle(text)
  });
};

/* ===== 再戦 ===== */
rematchBtn.onclick = () => {
  playersRef.once("value", snap => {
    snap.forEach(p => {
      p.ref.update({
        submitted: false,
        result: ""
      });
    });
  });
};

/* ===== 退出 ===== */
leaveBtn.onclick = () => {
  cleanup();
  playersRef.child(uid).remove().then(() => {
    location.href = "index.html";
  });
};

/* ===== 監視 ===== */
function setupListeners() {
  roomRef.on("value", snap => {
    const data = snap.val();
    if (!data || !data.players) return;

    const players = data.players;
    const ids = Object.keys(players);

    if (players[uid]) hasAppeared = true;

    /* 自分が消えた＝退出確定 */
    if (hasAppeared && !players[uid]) {
      cleanup();
      location.href = "index.html";
      return;
    }

    /* 0人 → ルーム削除 */
    if (ids.length === 0) {
      roomRef.remove();
      return;
    }

    /* 1人 → 初期状態 */
    if (ids.length === 1) {
      const onlyUid = ids[0];
      playersRef.child(onlyUid).update({
        submitted: false,
        result: ""
      });

      statusEl.textContent = "対戦相手の参加を待っています…";
      inputArea.style.display = "none";
      resultEl.style.display = "none";
      rematchBtn.style.display = "none";
      return;
    }

    /* 2人対戦 */
    const me = players[uid];
    const opponent = ids.find(id => id !== uid);
    const other = players[opponent];

    if (!me.submitted && !other.submitted) {
      statusEl.textContent = "入力して「実行」を押してください";
      inputArea.style.display = "block";
      resultEl.style.display = "none";
      rematchBtn.style.display = "none";
    } else if (!me.submitted && other.submitted) {
      statusEl.textContent = "相手は入力済みです。入力してください";
      inputArea.style.display = "block";
      resultEl.style.display = "none";
    } else if (me.submitted && !other.submitted) {
      statusEl.textContent = "相手の入力を待っています…";
      inputArea.style.display = "none";
      resultEl.style.display = "none";
    } else {
      statusEl.textContent = "結果発表！";
      inputArea.style.display = "none";
      resultEl.style.display = "block";
      rematchBtn.style.display = "inline";

      resultEl.textContent =
        `${me.name}: ${me.result}\n${other.name}: ${other.result}`;
    }
  });
}

/* ===== 後始末 ===== */
function cleanup() {
  if (roomRef) roomRef.off();
}

/* ===== シャッフル ===== */
function shuffle(str) {
  const arr = str.split("");
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.join("");
}
</script>
</body>
</html>
